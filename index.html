<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nitro Horizon: Evolution - Prototype</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto:wght@400;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #111827;
            color: white;
            overflow: hidden; /* Prevent scrolling while playing */
            touch-action: none;
        }
        
        h1, h2, h3, .brand-font {
            font-family: 'Russo One', sans-serif;
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.8), 0 0 20px rgba(59, 130, 246, 0.5);
        }

        .neon-border {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        #gameCanvas {
            background: #1f2937;
            border-left: 4px solid #374151;
            border-right: 4px solid #374151;
        }

        .stat-bar-bg {
            background-color: #374151;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            transition: width 0.3s ease;
        }

        /* Modal Styles */
        .modal {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transition: transform 0.1s, filter 0.2s;
        }
        .btn-primary:hover {
            filter: brightness(1.2);
            transform: scale(1.02);
        }
        .btn-primary:active {
            transform: scale(0.98);
        }

        .car-card {
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row">

    <!-- SIDEBAR / HUD (Mobile: Top, Desktop: Left) -->
    <div class="w-full md:w-1/3 lg:w-1/4 bg-gray-900 border-b md:border-b-0 md:border-r border-gray-700 p-4 flex flex-col justify-between z-10 shadow-xl">
        
        <div>
            <!-- Header -->
            <div class="mb-6 text-center md:text-left">
                <h1 class="text-3xl brand-font text-blue-500 italic neon-text mb-1">NITRO HORIZON</h1>
                <p class="text-xs text-gray-400 tracking-widest">EVOLUTION // PROTOTYPE v0.9</p>
            </div>

            <!-- Player Stats -->
            <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-700 shadow-lg">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400 text-sm">Piloto</span>
                    <span id="playerLevelDisplay" class="font-bold text-yellow-400">Nivel 1: Novato</span>
                </div>
                <div class="w-full bg-gray-700 h-2 rounded-full mb-4">
                    <div id="xpBar" class="bg-yellow-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-2 bg-gray-900 rounded border border-gray-700">
                        <div class="text-xs text-gray-500 uppercase">Créditos (CR)</div>
                        <div id="creditsDisplay" class="text-xl font-bold text-green-400 font-mono">0</div>
                    </div>
                    <div class="text-center p-2 bg-gray-900 rounded border border-gray-700">
                        <div class="text-xs text-gray-500 uppercase">Tokens (HT)</div>
                        <div id="tokensDisplay" class="text-xl font-bold text-purple-400 font-mono">0</div>
                    </div>
                </div>
            </div>

            <!-- Car Stats & Upgrades -->
            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-lg">
                <h3 class="brand-font text-xl text-white mb-4 border-b border-gray-700 pb-2"><i class="fas fa-wrench mr-2"></i> Taller</h3>
                
                <!-- Speed Upgrade -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Motor (Velocidad)</span>
                        <span id="speedVal" class="text-blue-400">Lvl 1</span>
                    </div>
                    <div class="stat-bar-bg mb-2">
                        <div id="speedBar" class="stat-bar-fill" style="width: 10%"></div>
                    </div>
                    <button onclick="upgrade('speed')" id="btnUpgradeSpeed" class="w-full py-1 px-2 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white border border-gray-600 transition">
                        Mejorar ($<span id="costSpeed">100</span>)
                    </button>
                </div>

                <!-- Handling Upgrade -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Neumáticos (Manejo)</span>
                        <span id="handlingVal" class="text-blue-400">Lvl 1</span>
                    </div>
                    <div class="stat-bar-bg mb-2">
                        <div id="handlingBar" class="stat-bar-fill" style="width: 10%"></div>
                    </div>
                    <button onclick="upgrade('handling')" id="btnUpgradeHandling" class="w-full py-1 px-2 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white border border-gray-600 transition">
                        Mejorar ($<span id="costHandling">100</span>)
                    </button>
                </div>

                <!-- Nitro Upgrade -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>Nitro Boost</span>
                        <span id="nitroVal" class="text-blue-400">Lvl 1</span>
                    </div>
                    <div class="stat-bar-bg mb-2">
                        <div id="nitroBar" class="stat-bar-fill" style="width: 10%"></div>
                    </div>
                    <button onclick="upgrade('nitro')" id="btnUpgradeNitro" class="w-full py-1 px-2 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white border border-gray-600 transition">
                        Mejorar ($<span id="costNitro">100</span>)
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-6 md:mt-0">
            <button onclick="startGame()" id="btnRace" class="btn-primary w-full py-4 rounded-lg font-bold text-xl uppercase tracking-wider shadow-lg neon-border text-white">
                <i class="fas fa-flag-checkered mr-2"></i> Correr
            </button>
            <p class="text-center text-gray-500 text-xs mt-2">Usa las Flechas Izq/Der para moverte. Espacio para Nitro.</p>
        </div>
    </div>

    <!-- MAIN GAME AREA -->
    <div class="relative flex-1 bg-black flex justify-center overflow-hidden">
        <canvas id="gameCanvas" class="h-full w-full max-w-2xl shadow-2xl"></canvas>
        
        <!-- UI Overlays -->
        <div id="gameUI" class="absolute top-4 right-4 flex flex-col gap-2 hidden">
            <div class="bg-black/50 p-2 rounded text-right">
                <div class="text-xs text-gray-400">DISTANCIA</div>
                <div class="text-xl font-mono font-bold"><span id="scoreDisplay">0</span>m</div>
            </div>
            <div class="bg-black/50 p-2 rounded text-right">
                <div class="text-xs text-gray-400">VELOCIDAD</div>
                <div class="text-xl font-mono text-yellow-500 font-bold"><span id="speedDisplay">0</span> km/h</div>
            </div>
        </div>

        <!-- Nitro Bar In-Game -->
        <div id="nitroContainer" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 w-64 h-4 bg-gray-800 rounded-full border border-gray-600 hidden overflow-hidden">
            <div id="nitroFill" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 width-full transition-all duration-100"></div>
            <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-[10px] font-bold tracking-widest text-white/80">NITRO BOOST</div>
        </div>

        <!-- Start Screen Overlay -->
        <div id="startScreen" class="absolute inset-0 flex items-center justify-center bg-black/80 z-20">
            <div class="text-center">
                <i class="fas fa-road text-6xl text-gray-600 mb-4 animate-pulse"></i>
                <h2 class="text-2xl text-gray-400">ESPERANDO PILOTO...</h2>
                <p class="text-gray-500 mt-2">Presiona "CORRER" en el panel lateral para iniciar.</p>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div id="gameOverModal" class="absolute inset-0 flex items-center justify-center modal hidden z-30">
            <div class="bg-gray-800 p-8 rounded-xl border border-blue-500 shadow-2xl max-w-sm w-full text-center">
                <h2 class="text-3xl brand-font text-white mb-2 italic">CARRERA TERMINADA</h2>
                
                <div class="flex justify-center space-x-4 my-6">
                    <div class="text-center">
                        <div class="text-gray-400 text-sm">Distancia</div>
                        <div id="finalScore" class="text-2xl font-bold text-white">0m</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-400 text-sm">Créditos</div>
                        <div id="finalCredits" class="text-2xl font-bold text-green-400">+0 CR</div>
                    </div>
                </div>

                <div class="bg-gray-900 p-3 rounded mb-6 text-left">
                    <div class="text-xs text-gray-500 uppercase mb-1">Progreso de Nivel</div>
                    <div class="flex justify-between text-sm text-yellow-400 mb-1">
                        <span>XP Ganada</span>
                        <span id="finalXp">+0 XP</span>
                    </div>
                    <div class="w-full bg-gray-700 h-2 rounded-full">
                        <div id="finalXpBar" class="bg-yellow-500 h-2 rounded-full" style="width: 50%"></div>
                    </div>
                </div>

                <button onclick="closeGameOver()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded font-bold text-white transition">CONTINUAR</button>
            </div>
        </div>
    </div>

    <script>
        // --- GAME STATE & CONFIGURATION ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game Logic
        let gameRunning = false;
        let animationId;
        let score = 0; // Distance
        let gameSpeed = 0;
        let roadOffset = 0;
        
        // Stats
        const gameState = {
            credits: 500, // Initial money
            tokens: 10,
            level: 1,
            xp: 0,
            xpToNextLevel: 1000,
            upgrades: {
                speed: 1,
                handling: 1,
                nitro: 1
            },
            costs: {
                speed: 200,
                handling: 200,
                nitro: 300
            }
        };

        // Car Physics
        const car = {
            x: 0, 
            y: 0, 
            width: 50, 
            height: 90, 
            lane: 1, // 0, 1, 2
            targetX: 0,
            speedX: 0,
            color: '#3b82f6',
            nitro: 100,
            isNitroActive: false
        };

        const lanes = [0, 0, 0]; // X positions of 3 lanes
        let obstacles = [];
        let particles = [];

        // --- INIT & RESIZE ---
        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            
            const laneWidth = canvas.width / 4; // Use middle 3/4 roughly
            const centerX = canvas.width / 2;
            
            lanes[0] = centerX - laneWidth;
            lanes[1] = centerX;
            lanes[2] = centerX + laneWidth;

            car.y = canvas.height - 150;
            // Reset car X to current lane
            car.targetX = lanes[car.lane];
            if(!gameRunning) car.x = car.targetX;
        }
        window.addEventListener('resize', resize);
        resize();
        updateUI();

        // --- INPUT HANDLING ---
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            
            // Added WASD support
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') changeLane(-1);
            if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') changeLane(1);
            if (e.key === ' ' || e.key.toLowerCase() === 'w') activateNitro(true);
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === ' ' || e.key.toLowerCase() === 'w') activateNitro(false);
        });

        // Touch Support for Mobile
        let touchStartX = 0;
        canvas.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
            // Tap bottom part for nitro
            if(e.touches[0].clientY > canvas.height * 0.8) {
                activateNitro(true);
            }
        });
        canvas.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].clientX;
            const diff = touchEndX - touchStartX;
            if (Math.abs(diff) > 30) {
                if (diff > 0) changeLane(1);
                else changeLane(-1);
            }
            activateNitro(false);
        });

        function changeLane(dir) {
            const newLane = car.lane + dir;
            if (newLane >= 0 && newLane < 3) {
                car.lane = newLane;
                car.targetX = lanes[car.lane];
            }
        }

        function activateNitro(active) {
            car.isNitroActive = active && car.nitro > 0;
        }

        // --- UPGRADE SYSTEM ---
        window.upgrade = function(type) {
            const cost = gameState.costs[type];
            if (gameState.credits >= cost && gameState.upgrades[type] < 10) {
                gameState.credits -= cost;
                gameState.upgrades[type]++;
                gameState.costs[type] = Math.floor(gameState.costs[type] * 1.5);
                
                // Play simple sound or visual effect here
                createParticles(canvas.width/2, canvas.height/2, 20, '#00ff00');
                updateUI();
            } else {
                // Shake button or show error
                const btn = document.getElementById(type === 'speed' ? 'btnUpgradeSpeed' : type === 'handling' ? 'btnUpgradeHandling' : 'btnUpgradeNitro');
                btn.classList.add('bg-red-600');
                setTimeout(() => btn.classList.remove('bg-red-600'), 200);
            }
        }

        function updateUI() {
            // Player Stats
            document.getElementById('creditsDisplay').innerText = gameState.credits.toLocaleString();
            document.getElementById('tokensDisplay').innerText = gameState.tokens.toLocaleString();
            document.getElementById('playerLevelDisplay').innerText = getLevelTitle(gameState.level);
            
            const xpPercent = (gameState.xp / gameState.xpToNextLevel) * 100;
            document.getElementById('xpBar').style.width = `${xpPercent}%`;

            // Upgrades
            updateUpgradeUI('speed', 'Speed', 'speedVal', 'speedBar', 'costSpeed');
            updateUpgradeUI('handling', 'Handling', 'handlingVal', 'handlingBar', 'costHandling');
            updateUpgradeUI('nitro', 'Nitro', 'nitroVal', 'nitroBar', 'costNitro');
        }

        function updateUpgradeUI(key, name, idVal, idBar, idCost) {
            const lvl = gameState.upgrades[key];
            document.getElementById(idVal).innerText = `Lvl ${lvl}`;
            document.getElementById(idBar).style.width = `${lvl * 10}%`;
            document.getElementById(idCost).innerText = gameState.costs[key].toLocaleString();
            
            if (lvl >= 10) {
                document.getElementById(idCost).parentElement.innerText = "MAX";
                document.getElementById(idCost).parentElement.disabled = true;
                document.getElementById(idCost).parentElement.classList.add('opacity-50');
            }
        }

        function getLevelTitle(lvl) {
            if (lvl <= 10) return `Nivel ${lvl}: Novato`;
            if (lvl <= 25) return `Nivel ${lvl}: Callejero`;
            if (lvl <= 50) return `Nivel ${lvl}: Profesional`;
            return `Nivel ${lvl}: Leyenda`;
        }

        // --- GAME LOOP ---
        window.startGame = function() {
            if (gameRunning) return;
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverModal').classList.add('hidden');
            document.getElementById('gameUI').classList.remove('hidden');
            document.getElementById('nitroContainer').classList.remove('hidden');
            document.getElementById('btnRace').innerText = "EN CARRERA...";
            document.getElementById('btnRace').disabled = true;
            document.getElementById('btnRace').classList.add('opacity-50', 'cursor-not-allowed');

            gameRunning = true;
            score = 0;
            car.nitro = 100;
            obstacles = [];
            particles = [];
            
            // Base speed depends on upgrade
            gameSpeed = 10 + (gameState.upgrades.speed * 1.5); 
            
            car.lane = 1;
            car.x = lanes[1];
            car.targetX = lanes[1];
            
            resize(); // Ensure alignment
            requestAnimationFrame(loop);
        }

        function loop() {
            if (!gameRunning) return;

            // 1. Update State
            updatePhysics();
            
            // 2. Draw
            ctx.fillStyle = '#111827';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            drawRoad();
            drawObstacles();
            drawParticles();
            drawPlayer();
            
            // UI Update inside loop
            document.getElementById('scoreDisplay').innerText = Math.floor(score);
            document.getElementById('speedDisplay').innerText = Math.floor(gameSpeed * 10);
            document.getElementById('nitroFill').style.width = `${car.nitro}%`;

            animationId = requestAnimationFrame(loop);
        }

        function updatePhysics() {
            // Speed logic
            let currentSpeed = 10 + (gameState.upgrades.speed * 1.5);
            if (car.isNitroActive) {
                currentSpeed *= 1.5;
                car.nitro -= 0.5;
                createParticles(car.x, car.y + 40, 2, '#3b82f6'); // Blue fire
                if(car.nitro <= 0) car.isNitroActive = false;
            } else if (car.nitro < 100) {
                car.nitro += 0.1; // Slow regen
            }
            
            // Ease speed changes
            gameSpeed = gameSpeed * 0.9 + currentSpeed * 0.1;
            
            score += gameSpeed / 20;
            roadOffset = (roadOffset + gameSpeed) % 40;

            // Car movement (Larping)
            const handling = 0.05 + (gameState.upgrades.handling * 0.015);
            car.x = car.x + (car.targetX - car.x) * handling;

            // Obstacle Spawning
            if (Math.random() < 0.02 + (score * 0.00001)) { // Get harder over time
                const lane = Math.floor(Math.random() * 3);
                // Ensure we don't spawn on top of another nearby
                const safe = !obstacles.some(o => o.lane === lane && o.y < -100);
                if (safe) {
                    obstacles.push({
                        lane: lane,
                        x: lanes[lane],
                        y: -150,
                        type: Math.random() > 0.8 ? 'coin' : 'car',
                        color: Math.random() > 0.8 ? '#ef4444' : '#ffffff' // Red or white cars
                    });
                }
            }

            // Obstacle Movement & Collision
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                // Relative speed: objects move down
                // If it's a car, it moves down slower (as if driving forward but slower than player)
                const obsSpeed = obs.type === 'coin' ? gameSpeed : (gameSpeed - 5); 
                obs.y += obsSpeed;

                // Collision Box
                const hitX = Math.abs(car.x - obs.x) < 40; // Approx width check
                const hitY = Math.abs(car.y - obs.y) < 70; // Approx height check

                if (hitX && hitY) {
                    if (obs.type === 'coin') {
                        // Collect coin
                        createParticles(obs.x, obs.y, 10, '#f59e0b');
                        score += 50; // Bonus score
                        gameState.credits += 10;
                        obstacles.splice(i, 1);
                    } else {
                        // Crash!
                        gameOver();
                        return;
                    }
                }

                if (obs.y > canvas.height + 100) {
                    obstacles.splice(i, 1);
                }
            }
        }

        // --- DRAWING ---
        function drawRoad() {
            ctx.save();
            ctx.shadowBlur = 0;
            
            // Road background
            const leftEdge = lanes[0] - 80;
            const rightEdge = lanes[2] + 80;
            ctx.fillStyle = '#374151'; // Asphalt
            ctx.fillRect(leftEdge, 0, rightEdge - leftEdge, canvas.height);
            
            // Lane markers
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 4;
            ctx.setLineDash([30, 30]);
            ctx.lineDashOffset = -roadOffset;

            // Lines between lanes
            const mid1 = (lanes[0] + lanes[1]) / 2;
            const mid2 = (lanes[1] + lanes[2]) / 2;

            ctx.beginPath();
            ctx.moveTo(mid1, -50);
            ctx.lineTo(mid1, canvas.height + 50);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(mid2, -50);
            ctx.lineTo(mid2, canvas.height + 50);
            ctx.stroke();

            // Edges (Solid)
            ctx.strokeStyle = '#f59e0b'; // Yellow lines
            ctx.lineWidth = 6;
            ctx.setLineDash([]);
            ctx.beginPath();
            ctx.moveTo(leftEdge + 10, 0);
            ctx.lineTo(leftEdge + 10, canvas.height);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(rightEdge - 10, 0);
            ctx.lineTo(rightEdge - 10, canvas.height);
            ctx.stroke();

            ctx.restore();
        }

        function drawPlayer() {
            ctx.save();
            ctx.translate(car.x, car.y);
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(-22, 10, 44, 80);

            // Car Body
            ctx.fillStyle = car.color;
            ctx.shadowColor = car.isNitroActive ? '#3b82f6' : 'transparent';
            ctx.shadowBlur = car.isNitroActive ? 20 : 0;
            
            // Main chassis
            ctx.beginPath();
            ctx.roundRect(-20, -40, 40, 80, 5);
            ctx.fill();

            // Roof/Window
            ctx.fillStyle = '#111827';
            ctx.fillRect(-15, -10, 30, 25);

            // Lights
            ctx.fillStyle = '#ef4444'; // Rear lights
            ctx.fillRect(-18, 35, 10, 5);
            ctx.fillRect(8, 35, 10, 5);

            // Nitro Flames
            if (car.isNitroActive) {
                ctx.fillStyle = '#60a5fa';
                ctx.beginPath();
                ctx.moveTo(-10, 40);
                ctx.lineTo(0, 40 + Math.random() * 30);
                ctx.lineTo(10, 40);
                ctx.fill();
            }

            ctx.restore();
        }

        function drawObstacles() {
            obstacles.forEach(obs => {
                ctx.save();
                ctx.translate(obs.x, obs.y);

                if (obs.type === 'coin') {
                    ctx.fillStyle = '#f59e0b';
                    ctx.shadowColor = '#f59e0b';
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(0, 0, 15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 16px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('$', 0, 1);
                } else {
                    // Enemy Car
                    ctx.fillStyle = obs.color;
                    ctx.beginPath();
                    ctx.roundRect(-20, -40, 40, 80, 5);
                    ctx.fill();
                    
                    // Windshield
                    ctx.fillStyle = '#000';
                    ctx.fillRect(-15, -20, 30, 15);
                    
                    // Headlights (facing player)
                    ctx.fillStyle = '#fbbf24'; // Yellow
                    ctx.fillRect(-18, 35, 10, 5);
                    ctx.fillRect(8, 35, 10, 5);
                }
                ctx.restore();
            });
        }

        function createParticles(x, y, count, color) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    life: 1.0,
                    color: color
                });
            }
        }

        function drawParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 3, 3);
                ctx.globalAlpha = 1.0;
                
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        // --- END GAME ---
        function gameOver() {
            gameRunning = false;
            cancelAnimationFrame(animationId);
            
            // Calculate Rewards
            const distanceCredits = Math.floor(score / 10);
            const totalCredits = distanceCredits;
            const xpGained = Math.floor(score / 5);
            
            gameState.credits += totalCredits;
            
            // Level Logic
            gameState.xp += xpGained;
            if (gameState.xp >= gameState.xpToNextLevel) {
                gameState.level++;
                gameState.xp -= gameState.xpToNextLevel;
                gameState.xpToNextLevel = Math.floor(gameState.xpToNextLevel * 1.2);
                gameState.tokens += 5; // Level up reward
                // Could show a separate modal for "Level Up" here
            }

            // Update UI
            document.getElementById('finalScore').innerText = Math.floor(score) + 'm';
            document.getElementById('finalCredits').innerText = '+' + totalCredits + ' CR';
            document.getElementById('finalXp').innerText = '+' + xpGained + ' XP';
            document.getElementById('finalXpBar').style.width = ((gameState.xp / gameState.xpToNextLevel) * 100) + '%';

            // Show Screens
            document.getElementById('gameUI').classList.add('hidden');
            document.getElementById('nitroContainer').classList.add('hidden');
            document.getElementById('gameOverModal').classList.remove('hidden');
            
            updateUI();
        }

        window.closeGameOver = function() {
            document.getElementById('gameOverModal').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('btnRace').innerText = '<i class="fas fa-flag-checkered mr-2"></i> Correr';
            document.getElementById('btnRace').disabled = false;
            document.getElementById('btnRace').classList.remove('opacity-50', 'cursor-not-allowed');
            
            // Draw one frame to clear the crash
            ctx.fillStyle = '#111827';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

    </script>
</body>
</html>